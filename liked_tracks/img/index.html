<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>eSound - Liked Tracks</title>
  <style>
    body {
      background: black;
      color: rgb(150, 0, 220);
      font-family: "Inter", Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .fixed-header {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 10;
    }
    .title-fixed-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 100px;
      padding: 10px 0;
    }
    a { 
        cursor: pointer; 
        text-decoration: none; 
        color: inherit; 
    }
    a:hover { 
        color: rgb(190,50,255); 
    }

    .main {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 20px 40px; 
      box-sizing: border-box;
      min-height: calc(100vh - 140px);
    }

    .track {
      width: 380px;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      transition: background 0.2s;
      cursor: default;
    }
    .track:hover { 
        background: #2b2b2b; 
    }

    .track-info { 
        display:flex; 
        flex-direction:column; 
        flex:1; 
        margin-right:15px; 
    }
    .title { 
        font-size:15px; 
        font-weight:500; 
    }
    .artist { 
        font-size:13px; 
        color:#aaa; 
        margin-top:2px; 
    }
    .controls { 
        display:flex; 
        align-items:center;
         gap:14px; 
    }

    .play-btn {
      width: 0; height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 12px solid white;
      cursor: pointer;
      transition: 0.2s;
    }
    .pause-btn {
      width: 12px; 
      height: 16px; 
      display:flex; 
      justify-content:space-between; 
      cursor:pointer;
    }
    .pause-btn span { 
        background:white; 
        width:4px; 
        height:100%; 
    }

    .heart {
      position: relative; 
      width:18px; 
      height:16px; 
      transform: rotate(-45deg); 
      cursor:pointer;
      transition:0.2s;
    }
    .heart::before, .heart::after {
      content:""; 
      position:absolute; 
      width:18px; 
      height:16px; 
      background:transparent;
      border:2px solid #888; 
      border-radius:50%; 
      top:0; 
      left:0; 
      transform:rotate(45deg);
      transition: all 0.25s ease;
    }
    .heart::after { 
        left:8px; 
    }
    .heart.active::before, .heart.active::after {
      background: rgb(190,50,255); 
      border-color: rgb(190,50,255); 
      box-shadow: 0 0 8px rgb(190,50,255);
    }
    .heart:hover::before, .heart:hover::after { 
        border-color: rgb(190,50,255); 
    }

    .progress { 
        width:100%; 
        height:4px; 
        background:#333; 
        border-radius:2px; 
        margin-top:8px; 
        overflow:hidden;
     }
    .progress-bar { 
        height:100%; 
        width:0; 
        background: rgb(190,50,255); 
        transition: width 0.1s linear; 
    }

    .empty { 
        color:#aaa; 
        text-align:center; 
        padding:40px 0; 
    }
    @media (max-width: 768px) {
            .title-fixed-header {
                gap: 50px;
            }
    }
  </style>
</head>
<body>
  <header class="fixed-header">
    <div class="title-fixed-header">
      <img src="img/logo.png" width="75" height="75" alt="logo">
      <p><strong>eSound</strong></p>
      <a href="../index.html"><p>Home</p></a>
      <a href="../liked_tracks/index.html"><p>Liked tracks</p></a>
    </div>
  </header>

  <section class="main">
    <div id="liked-list" class="main"></div>
  </section>

  <!-- single audio element used for all tracks -->
  <audio id="audio"></audio>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('liked-list');
    const audio = document.getElementById('audio');

    let likedTracks = JSON.parse(localStorage.getItem('likedTracks') || '[]');
    let currentTrackEl = null; // DOM element currently playing
    let progressTimer = null;

    function saveLikedArray() {
      localStorage.setItem('likedTracks', JSON.stringify(likedTracks));
    }

    function renderEmpty() {
      container.innerHTML = '<p class="empty">You haven\'t liked anything</p>';
    }

    function createTrackElement(track, index) {
      const div = document.createElement('div');
      div.className = 'track';
      div.dataset.src = track.src;
      div.dataset.index = String(index);
      div.innerHTML = `
        <div class="track-info">
          <span class="title">${escapeHtml(track.title)}</span>
          <span class="artist">${escapeHtml(track.artist)}</span>
          <div class="progress"><div class="progress-bar"></div></div>
        </div>
        <div class="controls">
          <div class="play-btn" aria-label="play"></div>
          <div class="heart active" data-index="${index}" aria-label="unlike"></div>
        </div>
      `;
      return div;
    }

    function renderList() {
      container.innerHTML = '';
      if (!likedTracks.length) {
        renderEmpty();
        return;
      }
      likedTracks.forEach((t, i) => {
        container.appendChild(createTrackElement(t, i));
      });
    }

    function resetUIForAll() {
      // replace all pause buttons with play-btn and reset progress
      document.querySelectorAll('.pause-btn').forEach(pb => {
        pb.outerHTML = '<div class="play-btn"></div>';
      });
      document.querySelectorAll('.progress-bar').forEach(bar => bar.style.width = '0%');
    }

    // play/pause logic for a track DOM element
    function playTrackEl(trackEl) {
      const src = trackEl.dataset.src;
      if (!src) return;

      // if clicked the same track and it's playing -> pause
      if (currentTrackEl === trackEl && !audio.paused) {
        audio.pause();
        stopProgressTimer();
        // swap to play button
        const controls = trackEl.querySelector('.controls');
        controls.querySelector('.pause-btn')?.remove();
        if (!controls.querySelector('.play-btn')) controls.insertAdjacentHTML('afterbegin', '<div class="play-btn"></div>');
        return;
      }

      // start playing a new track
      resetUIForAll();
      currentTrackEl = trackEl;
      audio.src = src;
      audio.play().catch(() => {
        // playback may fail if user hasn't interacted with page - ignore silently
      });

      // replace play button with pause-btn
      const controls = trackEl.querySelector('.controls');
      controls.querySelector('.play-btn')?.remove();
      if (!controls.querySelector('.pause-btn')) {
        controls.insertAdjacentHTML('afterbegin', '<div class="pause-btn"><span></span><span></span></div>');
      }

      // start updating progress
      startProgressTimerFor(trackEl);
    }

    function startProgressTimerFor(trackEl) {
      stopProgressTimer();
      progressTimer = setInterval(() => {
        if (!audio.duration || !trackEl) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        const bar = trackEl.querySelector('.progress-bar');
        if (bar) bar.style.width = pct + '%';
      }, 100);
    }

    function stopProgressTimer() {
      if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
      }
    }

    // when track ends — reset UI for that track
    audio.addEventListener('ended', () => {
      if (currentTrackEl) {
        currentTrackEl.querySelector('.pause-btn')?.remove();
        if (!currentTrackEl.querySelector('.play-btn')) currentTrackEl.querySelector('.controls').insertAdjacentHTML('afterbegin','<div class="play-btn"></div>');
        const bar = currentTrackEl.querySelector('.progress-bar');
        if (bar) bar.style.width = '0%';
      }
      currentTrackEl = null;
      stopProgressTimer();
    });

    // Event delegation: handle play/pause and heart clicks on container
    container.addEventListener('click', (e) => {
      const playBtn = e.target.closest('.play-btn');
      const pauseBtn = e.target.closest('.pause-btn');
      const heart = e.target.closest('.heart');
      const trackEl = e.target.closest('.track');

      if (heart) {
        // unlike: remove from likedTracks and re-render
        e.stopPropagation();
        const idxStr = heart.dataset.index;
        if (typeof idxStr === 'undefined') return;
        const idx = Number(idxStr);
        // if the removed track is currently playing — stop audio
        const removedTrackSrc = likedTracks[idx]?.src;
        if (currentTrackEl && currentTrackEl.dataset.src === removedTrackSrc) {
          audio.pause();
          audio.src = '';
          stopProgressTimer();
          currentTrackEl = null;
        }
        likedTracks.splice(idx, 1);
        saveLikedArray();
        renderList();
        // after rerender indexes changed, nothing else to do
        return;
      }

      if (playBtn) {
        e.stopPropagation();
        const tr = playBtn.closest('.track');
        if (!tr) return;
        playTrackEl(tr);
        return;
      }

      if (pauseBtn) {
        e.stopPropagation();
        // pause current track
        audio.pause();
        stopProgressTimer();
        const tr = pauseBtn.closest('.track');
        if (tr) {
          // swap to play button
          pauseBtn.remove();
          if (!tr.querySelector('.play-btn')) tr.querySelector('.controls').insertAdjacentHTML('afterbegin','<div class="play-btn"></div>');
        }
        return;
      }

      // clicking on track area (outside controls) toggles play/pause
      if (trackEl) {
        playTrackEl(trackEl);
      }
    });

    // helper: escape HTML in titles/artists to avoid injection
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/[&<>"']/g, (m) => {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    // initial render
    renderList();
  });
  </script>
</body>
</html>